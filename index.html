<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPIC Penguin Rescue - Fixed</title>
    <style>
        :root {
            --sky-blue: #87ceeb;
            --ice-white: #f0f8ff;
            --term-green: #00ff41;
            --error-red: #ff4757;
            --ocean-blue: #1e3799;
        }

        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: var(--sky-blue); }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        #world { display: flex; flex-direction: column; height: 100vh; }
        #sky { flex: 3; position: relative; background: linear-gradient(to bottom, #2980b9, #6dd5fa); }
        #typing-area { flex: 4; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        #ground { flex: 3; background: linear-gradient(to bottom, #fff 0%, var(--ice-white) 100%); position: relative; border-top: 5px solid #dff9fb; }

        .cloud { position: absolute; background: #fff; width: 120px; height: 45px; border-radius: 50px; opacity: 0.9; animation: moveCloud linear infinite; }
        @keyframes moveCloud { from { transform: translateX(110vw); } to { transform: translateX(-20vw); } }

        /* --- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°è¡¨ç¤º --- */
        #cmd-display { background: rgba(0, 0, 0, 0.8); padding: 40px; border-radius: 25px; border: 4px solid #fff; text-align: center; min-width: 300px; max-width: 80%; }
        #target-desc { color: #bdc3c7; font-size: 1.2rem; margin-bottom: 10px; }
        #target-text { font-family: 'Consolas', monospace; font-size: 2.5rem; color: #fff; letter-spacing: 2px; word-break: break-all; }
        .correct { color: var(--term-green); }
        .current { border-bottom: 4px solid #fff; }

        /* --- ãƒšãƒ³ã‚®ãƒ³ã¨ç©´ --- */
        #penguin { position: absolute; bottom: 50px; left: 10%; font-size: 5rem; z-index: 20; transition: transform 0.2s; }
        #pit { position: absolute; right: 0; bottom: 0; width: 15%; height: 100%; background: var(--ocean-blue); clip-path: polygon(25% 0, 100% 0, 100% 100%, 0% 100%); }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ãƒªã‚¶ãƒ«ãƒˆç”»é¢ï¼ˆã“ã“ãŒé‡è¦ï¼‰ --- */
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; /* æœ€å‰é¢ã« */
            color: white; 
        }

        .diff-select { margin: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        
        /* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ã */
        .diff-btn, #main-start, .retry-btn {
            padding: 15px 30px;
            cursor: pointer;
            border-radius: 50px;
            border: none;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.2s;
            pointer-events: auto; /* ã‚¯ãƒªãƒƒã‚¯ã‚’ç¢ºå®Ÿã«æœ‰åŠ¹åŒ– */
        }

        .diff-btn { background: #555; color: white; border: 2px solid #fff; }
        .diff-btn.active { background: var(--term-green); color: black; }
        
        #main-start { background: var(--term-green); color: black; font-size: 2rem; margin-top: 20px; width: 300px; }
        #main-start:hover { transform: scale(1.05); background: #00d336; }

        .miss-flash { animation: flash 0.1s; }
        @keyframes flash { from { background-color: var(--error-red); } to { background-color: transparent; } }
    </style>
</head>
<body>

<div id="world">
    <div id="sky"><div class="cloud" style="top: 20%; animation-duration: 30s;"></div></div>
    <div id="typing-area">
        <div id="cmd-display">
            <div id="target-desc">ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
            <div id="target-text">READY?</div>
        </div>
    </div>
    <div id="ground">
        <div id="penguin">ğŸ§</div>
        <div id="pit"></div>
    </div>
</div>

<div id="start-screen" class="overlay">
    <h1 style="font-size: 3rem; margin-bottom: 10px;">ğŸ§ LPIC RESCUE</h1>
    <p>é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    <div class="diff-select">
        <button class="diff-btn" onclick="setDifficulty(2.5, this)">3000å††ã‚³ãƒ¼ã‚¹</button>
        <button class="diff-btn active" onclick="setDifficulty(4.0, this)">5000å††ã‚³ãƒ¼ã‚¹</button>
        <button class="diff-btn" onclick="setDifficulty(6.5, this)">10000å††ã‚³ãƒ¼ã‚¹</button>
    </div>
    <button id="main-start" onclick="startGame()">START</button>
</div>

<div id="result-screen" class="overlay" style="display: none;">
    <h2 style="font-size: 3rem;">RESULT</h2>
    <div id="stats" style="font-size: 1.5rem; margin: 30px; text-align: center;"></div>
    <button class="retry-btn" style="background:var(--term-green);" onclick="location.reload()">RETRY</button>
</div>

<script>
    // å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆãƒŸã‚¹é˜²æ­¢ã®ãŸã‚æœ€å°é™ã®ç¢ºèªæ¸ˆã¿ãƒªã‚¹ãƒˆï¼‰
    const baseQuestions = [
        { cmd: "ls -la", desc: "éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚€å…¨ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°è¡¨ç¤º" },
        { cmd: "ls -ltr", desc: "æ›´æ–°æ—¥æ™‚ãŒå¤ã„é †ã«è¡¨ç¤º" },
        { cmd: "cp -rp src dest", desc: "å±æ€§ä¿æŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚³ãƒ”ãƒ¼" },
        { cmd: "rm -rf tmp", desc: "å¼·åˆ¶ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤" },
        { cmd: "mkdir -p a/b", desc: "éšå±¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€æ‹¬ä½œæˆ" },
        { cmd: "chmod 755 sh", desc: "å®Ÿè¡Œæ¨©é™ä»˜ä¸" },
        { cmd: "chown root file", desc: "æ‰€æœ‰è€…å¤‰æ›´" },
        { cmd: "ps aux", desc: "ãƒ—ãƒ­ã‚»ã‚¹è©³ç´°è¡¨ç¤º" },
        { cmd: "df -h", desc: "ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡è¡¨ç¤º" },
        { cmd: "ip addr", desc: "IPã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤º" },
        { cmd: "systemctl start ssh", desc: "ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•" }
    ];

    let gameQuestions = [];
    let qIndex = 0;
    let currentQ, typedIndex, score, timeLeft, gameActive = false;
    let penguinPos = 10;
    let charsPerSecond = 4.0;
    let audioCtx = null;

    // é›£æ˜“åº¦ã‚»ãƒƒãƒˆ
    window.setDifficulty = function(cps, btn) {
        charsPerSecond = cps;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tryInitAudio();
    };

    function tryInitAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(freq, type, duration) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    window.startGame = function() {
        tryInitAudio();
        document.getElementById('start-screen').style.display = 'none';
        gameQuestions = shuffle([...
